name: Pipeline Performance Completa

on:
  workflow_dispatch:

jobs:
  performance:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose curl wget python3-pip unzip

      # ============================================================
      # TEASTORE ‚Äî INICIAR STACK
      # ============================================================
      - name: Start TeaStore
        run: |
          echo "üöÄ Subindo TeaStore stack"
          docker compose up -d
          echo "‚è≥ Aguardando 60s..."
          sleep 60
          docker ps

      # ============================================================
      # VERIFICAR WEBUI (ENDPOINT BASE)
      # ============================================================
      - name: Test WebUI Online
        run: |
          echo "‚è≥ Testando WebUI..."
          for i in {1..20}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:18081/tools.descartes.teastore.webui/)
            echo "Tentativa $i: HTTP $CODE"

            if [ "$CODE" = "200" ] || [ "$CODE" = "302" ]; then
              echo "üü¢ WebUI ONLINE!"
              exit 0
            fi
            
            sleep 5
          done
          echo "‚ùå WebUI n√£o respondeu."
          exit 1

      # ============================================================
      # JMETER ‚Äî INSTALA√á√ÉO
      # ============================================================
      - name: Install JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xzf apache-jmeter-5.6.2.tgz

      # ============================================================
      # JMETER ‚Äî TESTE SIMPLES
      # ============================================================
      - name: Run JMeter Simples
        run: |
          ./apache-jmeter-5.6.2/bin/jmeter -n \
           -t jmeter-teastore/teste-carga-simples.jmx \
           -l jmeter-teastore/results-simples.jtl \
           -e -o jmeter-teastore/report-simples \
           -Jhostname=localhost -Jport=18081 || true

      # ============================================================
      # JMETER ‚Äî TESTE COMPLEXO
      # ============================================================
      - name: Run JMeter Complexos
        run: |
          ./apache-jmeter-5.6.2/bin/jmeter -n \
           -t jmeter-teastore/cenarios-complexos.jmx \
           -l jmeter-teastore/results-complexos.jtl \
           -e -o jmeter-teastore/report-complexos \
           -Jhostname=localhost -Jport=18081 || true

      - name: Upload JMeter Reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-reports
          path: |
            jmeter-teastore/report-simples
            jmeter-teastore/report-complexos

      # ============================================================
      # K6 ‚Äî INSTALA√á√ÉO
      # ============================================================
      - name: Install K6
        run: |
          curl -s https://dl.k6.io/key.gpg | sudo apt-key add -
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      # ============================================================
      # K6 ‚Äî TESTE SIMPLES
      # ============================================================
      - name: Run K6 Simples
        run: |
          k6 run k6-teastore/teste-carga-simples.js \
            --out web-dashboard \
            --summary-export=k6-simples.json || true

      # ============================================================
      # K6 ‚Äî TESTE COMPLEXO
      # ============================================================
      - name: Run K6 Complexos
        run: |
          k6 run k6-teastore/cenarios-complexos.js \
            --out web-dashboard \
            --summary-export=k6-complexos.json || true

      - name: Upload K6 Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: k6-dashboard
          path: |
            k6-results/
            k6-simples.json
            k6-complexos.json

      # ============================================================
      # LOCUST ‚Äî INSTALAR
      # ============================================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust
        run: pip install locust

      # ============================================================
      # LOCUST ‚Äî TESTE SIMPLES
      # ============================================================
      - name: Run Locust Simples
        run: |
          locust -f locust-teastore/locustfile.py \
            --headless --host http://localhost:18081 \
            -u 10 -r 2 -t 20s \
            --html locust-simples.html || true

      # ============================================================
      # LOCUST ‚Äî TESTE COMPLEXO
      # ============================================================
      - name: Run Locust Complexos
        run: |
          locust -f locust-teastore/cenarios-complexos-locust.py \
            --headless --host http://localhost:18081 \
            -u 20 -r 3 -t 30s \
            --html locust-complexos.html || true

      - name: Upload Locust Reports
        uses: actions/upload-artifact@v4
        with:
          name: locust-reports
          path: |
            locust-simples.html
            locust-complexos.html

      # ============================================================
      # ENCERRAR STACK
      # ============================================================
      - name: Stop containers
        if: always()
        run: docker compose down
