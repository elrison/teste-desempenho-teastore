name: Teste de Desempenho — TeaStore v13

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  performance-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositório
        uses: actions/checkout@v4

      # =====================
      # DEPENDÊNCIAS
      # =====================
      - name: Instalar dependências
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip default-jdk unzip wget
          pip install reportlab beautifulsoup4 requests locust

          # Instalação do K6
          curl -s https://dl.k6.io/key.gpg | sudo apt-key add -
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update && sudo apt-get install -y k6

          # Instalação do Apache JMeter
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xzf apache-jmeter-5.6.2.tgz
          sudo mv apache-jmeter-5.6.2 /opt/jmeter
          echo "export PATH=$PATH:/opt/jmeter/bin" >> ~/.bashrc
          source ~/.bashrc

      # =====================
      # TESTES K6
      # =====================
      - name: Executar teste simples (K6)
        run: |
          mkdir -p k6-reports
          k6 run ./k6-teastore/teste-carga-simples.js --summary-export=k6-reports/simple.json

      - name: Executar teste complexo (K6)
        run: |
          k6 run ./k6-teastore/teste-carga-complexo.js --summary-export=k6-reports/complex.json

      # =====================
      # TESTES JMETER
      # =====================
      - name: Executar teste simples (JMeter)
        run: |
          mkdir -p jmeter-teastore/report-simples
          /opt/jmeter/bin/jmeter -n -t ./jmeter-teastore/teste-simples.jmx \
            -l ./jmeter-teastore/results-simples.jtl \
            -e -o ./jmeter-teastore/report-simples

      - name: Executar teste complexo (JMeter)
        run: |
          mkdir -p jmeter-teastore/report-complexos
          /opt/jmeter/bin/jmeter -n -t ./jmeter-teastore/teste-complexos.jmx \
            -l ./jmeter-teastore/results-complexos.jtl \
            -e -o ./jmeter-teastore/report-complexos

      # =====================
      # TESTES LOCUST
      # =====================
      - name: Executar teste simples (Locust)
        run: |
          mkdir -p locust-reports
          locust -f ./locust-teastore/cenarios-simples-locust.py --headless -u 10 -r 2 -t 30s \
            --html locust-reports/simples.html --csv locust-reports/simples

      - name: Executar teste complexo (Locust)
        run: |
          locust -f ./locust-teastore/cenarios-complexos-locust.py --headless -u 10 -r 2 -t 30s \
            --html locust-reports/complex.html --csv locust-reports/complex

      # =====================
      # DASHBOARD E PDF
      # =====================
      - name: Gerar dashboard consolidado e PDF
        run: |
          python3 ./tools/generate_dashboard.py \
            --k6 ./k6-reports/complex.json \
            --jmeter ./jmeter-teastore/report-complexos/index.html \
            --locust ./locust-reports/complex.html \
            --out ./dashboard.html \
            --pdf ./relatorio.pdf

      # =====================
      # PUBLICAR RESULTADOS
      # =====================
      - name: Publicar artefatos
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-teastore-v13
          path: |
            ./k6-reports/*.json
            ./jmeter-teastore/report-*/**
            ./locust-reports/*.html
            ./dashboard.html
            ./relatorio.pdf
