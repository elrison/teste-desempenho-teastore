name: Teste de Desempenho - TeaStore v15

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  performance:
    runs-on: ubuntu-latest

    steps:
      # ======================================================
      # 1. Checkout do reposit√≥rio
      # ======================================================
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      # ======================================================
      # 2. Instalar depend√™ncias
      # ======================================================
      - name: Instalar depend√™ncias
        run: |
          sudo apt update -y
          sudo apt install -y default-jdk python3 python3-pip unzip wget curl
          pip install matplotlib pandas reportlab

          # ‚úÖ Instalar √∫ltima vers√£o do K6
          K6_VERSION=$(curl -s https://api.github.com/repos/grafana/k6/releases/latest | grep tag_name | cut -d '"' -f 4)
          echo "üîπ Baixando K6 vers√£o: $K6_VERSION"
          wget https://github.com/grafana/k6/releases/download/${K6_VERSION}/k6-${K6_VERSION}-linux-amd64.tar.gz
          tar -xvzf k6-${K6_VERSION}-linux-amd64.tar.gz
          sudo mv k6-${K6_VERSION}-linux-amd64/k6 /usr/local/bin/

          # ‚úÖ Instalar Apache JMeter 5.6.3
          wget https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-5.6.3.zip
          unzip -q apache-jmeter-5.6.3.zip
          sudo mv apache-jmeter-5.6.3 /opt/jmeter

          # ‚úÖ Instalar Locust
          pip install locust

      # ======================================================
      # 3. Executar K6 com Web Dashboard e salvar relat√≥rio HTML
      # ======================================================
      - name: Executar teste simples (K6) com Web Dashboard
        run: |
          mkdir -p k6-reports
          echo "üåê Executando teste simples com Web Dashboard..."
          k6 run --out web-dashboard=./k6-reports/dashboard-simple ./k6-teastore/teste-carga-simples.js --summary-export=k6-reports/simple.json
          echo "‚úÖ Dashboard salvo em ./k6-reports/dashboard-simple"

      - name: Executar teste complexo (K6) com Web Dashboard
        run: |
          mkdir -p k6-reports
          echo "üåê Executando teste complexo com Web Dashboard..."
          k6 run --out web-dashboard=./k6-reports/dashboard-complex ./k6-teastore/cenarios-complexos.js --summary-export=k6-reports/complex.json
          echo "‚úÖ Dashboard salvo em ./k6-reports/dashboard-complex"

      # ======================================================
      # 4. Executar JMeter (com dashboards HTML)
      # ======================================================
      - name: Executar testes JMeter
        run: |
          mkdir -p jmeter-reports

          SIMPLE="./jmeter-teastore/teste-carga-simples.jmx"
          COMPLEX="./jmeter-teastore/cenarios-complexos.jmx"

          echo "üß™ Executando JMeter - Teste Simples..."
          /opt/jmeter/bin/jmeter -n -t "$SIMPLE" -l jmeter-reports/simple.jtl -e -o jmeter-reports/dashboard-simple

          echo "üß™ Executando JMeter - Teste Complexo..."
          /opt/jmeter/bin/jmeter -n -t "$COMPLEX" -l jmeter-reports/complex.jtl -e -o jmeter-reports/dashboard-complex

          echo "‚úÖ Dashboards HTML gerados com sucesso!"

      # ======================================================
      # 5. Executar Locust (inalterado)
      # ======================================================
      - name: Executar testes Locust
        run: |
          mkdir -p locust-reports
          locust -f ./locust-teastore/locustfile.py --headless -u 10 -r 2 -t 30s --csv=locust-reports/locust

      # ======================================================
      # 6. Gerar Dashboard Consolidado (HTML + PDF)
      # ======================================================
      - name: Gerar Dashboard Consolidado
        run: |
          mkdir -p reports
          echo "üìä Gerando dashboard consolidado..."
          python3 generate_dashboard.py \
            --k6 k6-reports/complex.json \
            --jmeter jmeter-reports/complex.jtl \
            --locust locust-reports/locust_stats.csv \
            --out reports/dashboard.html \
            --pdf reports/dashboard.pdf

      # ======================================================
      # 7. Upload dos Relat√≥rios (inclui dashboards do K6)
      # ======================================================
      - name: Upload dos Relat√≥rios
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-desempenho-v15
          path: |
            k6-reports/
            jmeter-reports/
            locust-reports/
            reports/
