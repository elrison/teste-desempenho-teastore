name: Teste de Desempenho - TeaStore v14

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  performance:
    runs-on: ubuntu-latest

    steps:
      # ======================================================
      # 1. Checkout do repositÃ³rio
      # ======================================================
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4

            # ======================================================
      # 2. Instalar dependÃªncias
      # ======================================================
      - name: Instalar dependÃªncias
        run: |
          sudo apt update -y
          sudo apt install -y default-jdk python3 python3-pip unzip wget
          pip install matplotlib pandas reportlab

          # âœ… Instalar k6 (URL corrigida - novo repositÃ³rio oficial)
          wget https://github.com/grafana/k6/releases/latest/download/k6-v0.49.0-linux-amd64.tar.gz
          tar -xvzf k6-v0.49.0-linux-amd64.tar.gz
          sudo mv k6-v0.49.0-linux-amd64/k6 /usr/local/bin/

          # âœ… Instalar JMeter com suporte a grÃ¡ficos completos
          wget https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-5.6.3.zip
          unzip -q apache-jmeter-5.6.3.zip
          sudo mv apache-jmeter-5.6.3 /opt/jmeter

          # âœ… Instalar Locust
          pip install locust

      # ======================================================
      # 3. Executar K6 com Web Dashboard
      # ======================================================
      - name: Executar teste simples (K6) com Web Dashboard
        run: |
          mkdir -p k6-reports
          echo "ðŸŒ Iniciando K6 Web Dashboard..."
          nohup k6 run --out web-dashboard ./k6-teastore/teste-carga-simples.js --summary-export=k6-reports/simple.json > k6-reports/simple.log 2>&1 &

          sleep 10
          echo "âœ… Dashboard disponÃ­vel temporariamente no runner (modo headless CI)."
          sleep 10

      - name: Executar teste complexo (K6) com Web Dashboard
        run: |
          mkdir -p k6-reports
          echo "ðŸŒ Executando teste complexo com K6 Web Dashboard..."
          nohup k6 run --out web-dashboard ./k6-teastore/teste-carga-complexo.js --summary-export=k6-reports/complex.json > k6-reports/complex.log 2>&1 &
          sleep 15

      # ======================================================
      # 4. Executar JMeter (Simples + Complexo com grÃ¡ficos)
      # ======================================================
      - name: Executar testes JMeter (com dashboards)
        run: |
          mkdir -p jmeter-reports

          SIMPLE="./jmeter-teastore/teste-simples.jmx"
          COMPLEX="./jmeter-teastore/teste-complexo.jmx"

          echo "ðŸ§ª Executando JMeter Simples..."
          /opt/jmeter/bin/jmeter -n -t "$SIMPLE" -l jmeter-reports/simple.jtl -e -o jmeter-reports/dashboard-simple

          echo "ðŸ§ª Executando JMeter Complexo..."
          /opt/jmeter/bin/jmeter -n -t "$COMPLEX" -l jmeter-reports/complex.jtl -e -o jmeter-reports/dashboard-complex

          echo "âœ… RelatÃ³rios HTML gerados em jmeter-reports/dashboard-simple e dashboard-complex"

      # ======================================================
      # 5. Executar Locust (mantido)
      # ======================================================
      - name: Executar testes Locust
        run: |
          mkdir -p locust-reports
          locust -f ./locust-teastore/locustfile.py --headless -u 10 -r 2 -t 30s --csv=locust-reports/locust

      # ======================================================
      # 6. Gerar Dashboard Consolidado (PDF + HTML)
      # ======================================================
      - name: Gerar Dashboard Consolidado
        run: |
          mkdir -p reports
          python3 generate_dashboard.py \
            --k6 k6-reports/complex.json \
            --jmeter jmeter-reports/complex.jtl \
            --locust locust-reports/locust_stats.csv \
            --out reports/dashboard.html \
            --pdf reports/dashboard.pdf

      # ======================================================
      # 7. Upload dos RelatÃ³rios
      # ======================================================
      - name: Upload dos RelatÃ³rios
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-desempenho-v14
          path: |
            k6-reports/
            jmeter-reports/
            locust-reports/
            reports/
