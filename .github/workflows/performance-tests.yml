name: Pipeline de Performance v11 (Completo)

on:
  workflow_dispatch:

jobs:
  performance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install base deps
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose python3-venv curl wget openjdk-11-jre-headless

      - name: Start TeaStore
        run: |
          docker compose up -d
          echo "⏳ Aguardando WebUI..."
          for i in {1..40}; do
            if curl -s http://localhost:18081/tools.descartes.teastore.webui/login | grep -q "_csrf"; then
              echo "✅ WebUI OK!"
              exit 0
            fi
            echo "Aguardando..."
            sleep 5
          done
          exit 1

      - name: Install JMeter
        run: |
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xzf apache-jmeter-5.6.2.tgz

      - name: Run JMeter Simples
        run: |
          ./apache-jmeter-5.6.2/bin/jmeter -n -t jmeter-teastore/simples.jmx \
          -l jmeter-teastore/simples.jtl -e -o jmeter-teastore/simples-report

      - name: Run JMeter Complexos
        run: |
          ./apache-jmeter-5.6.2/bin/jmeter -n -t jmeter-teastore/complexos.jmx \
          -l jmeter-teastore/complexos.jtl -e -o jmeter-teastore/complexos-report

      - name: Upload JMeter Reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-reports
          path: jmeter-teastore/*report

      - name: Install K6
        run: |
          sudo apt-get install -y gnupg
          curl -s https://dl.k6.io/key.gpg | sudo apt-key add -
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update && sudo apt-get install -y k6

      - name: Run K6 Simples
        run: k6 run k6-teastore/simples.js --summary-export=k6-simples.json

      - name: Run K6 Complexos
        run: k6 run k6-teastore/complexos.js --summary-export=k6-complexos.json || true

      - name: Upload K6 Reports
        uses: actions/upload-artifact@v4
        with:
          name: k6-reports
          path: "k6-*.json"

      - name: Setup Python for Locust & Reports
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python libs
        run: |
          python3 -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install locust requests beautifulsoup4 pandas jinja2 reportlab matplotlib

      - name: Run Locust Simples
        run: |
          . .venv/bin/activate
          locust -f locust-teastore/simples.py --headless -u 5 -r 1 -t 20s --host http://localhost:18081 \
          --html locust-teastore/simples.html

      - name: Run Locust Complexos
        run: |
          . .venv/bin/activate
          locust -f locust-teastore/complexos-locust.py --headless -u 10 -r 2 -t 30s --host http://localhost:18081 \
          --html locust-teastore/complexos.html

      - name: Upload Locust Reports
        uses: actions/upload-artifact@v4
        with:
          name: locust-reports
          path: locust-teastore/*.html

      - name: Generate Dashboard and PDF
        run: |
          . .venv/bin/activate
          python3 tools/generate_dashboard.py --k6 k6-complexos.json --jmeter jmeter-teastore/complexos-report/index.html \
          --locust locust-teastore/complexos.html --out dashboard.html --pdf report.pdf

      - name: Upload Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-final
          path: |
            dashboard.html
            report.pdf
