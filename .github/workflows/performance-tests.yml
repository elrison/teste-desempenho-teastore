name: Teste de Desempenho - TeaStore v14

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  performance:
    runs-on: ubuntu-latest

    steps:
      # ======================================================
      # 1. Checkout do repositÃ³rio
      # ======================================================
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4

      # ======================================================
      # 2. Instalar dependÃªncias
      # ======================================================
      - name: Instalar dependÃªncias
        run: |
          sudo apt update -y
          sudo apt install -y default-jdk python3 python3-pip unzip wget curl
          pip install matplotlib pandas reportlab

          # âœ… Instalar Ãºltima versÃ£o do k6 (sem erro 404)
          K6_VERSION=$(curl -s https://api.github.com/repos/grafana/k6/releases/latest | grep tag_name | cut -d '"' -f 4)
          echo "ðŸ”¹ Baixando K6 versÃ£o: $K6_VERSION"
          wget https://github.com/grafana/k6/releases/download/${K6_VERSION}/k6-${K6_VERSION}-linux-amd64.tar.gz
          tar -xvzf k6-${K6_VERSION}-linux-amd64.tar.gz
          sudo mv k6-${K6_VERSION}-linux-amd64/k6 /usr/local/bin/

          # âœ… Instalar JMeter (com suporte a dashboards)
          wget https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-5.6.3.zip
          unzip -q apache-jmeter-5.6.3.zip
          sudo mv apache-jmeter-5.6.3 /opt/jmeter

          # âœ… Instalar Locust
          pip install locust

      # ======================================================
      # 3. Executar K6 com Web Dashboard
      # ======================================================
      - name: Executar teste simples (K6) com Web Dashboard
        run: |
          mkdir -p k6-reports
          echo "ðŸŒ Iniciando K6 Web Dashboard (teste simples)..."
          nohup k6 run --out web-dashboard ./k6-teastore/teste-carga-simples.js --summary-export=k6-reports/simple.json > k6-reports/simple.log 2>&1 &
          sleep 10
          echo "âœ… K6 Web Dashboard ativo (modo headless)."
          sleep 10

      - name: Executar teste complexo (K6) com Web Dashboard
        run: |
          mkdir -p k6-reports
          echo "ðŸŒ Executando teste complexo com K6 Web Dashboard..."
          nohup k6 run --out web-dashboard ./k6-teastore/cenarios-complexos.js --summary-export=k6-reports/complex.json > k6-reports/complex.log 2>&1 &
          sleep 15

      # ======================================================
      # 4. Executar JMeter (Simples + Complexo com dashboards HTML)
      # ======================================================
      - name: Executar testes JMeter (com dashboards)
        run: |
          mkdir -p jmeter-reports

          SIMPLE="jmeter-teastore/teste-carga-simples.jmx"
          COMPLEX="jmeter-teastore/cenarios-complexos.jmx"

          echo "ðŸ§ª Executando JMeter - Teste Simples..."
          /opt/jmeter/bin/jmeter -n -t "$SIMPLE" -l jmeter-reports/simple.jtl -e -o jmeter-reports/dashboard-simple

          echo "ðŸ§ª Executando JMeter - Teste Complexo..."
          /opt/jmeter/bin/jmeter -n -t "$COMPLEX" -l jmeter-reports/complex.jtl -e -o jmeter-reports/dashboard-complex

          echo "âœ… Dashboards HTML gerados com sucesso!"

  locust-tests:
    name: Locust - Carga Simples e Complexa
    runs-on: ubuntu-latest

    steps:
      # ======================================================
      # 1. CorreÃ§Ã£o e Checkout do repositÃ³rio
      # ======================================================
      - name: Remover arquivo .gitmodules (CorreÃ§Ã£o ForÃ§ada)
        run: |
          if [ -f ".gitmodules" ]; then
            echo "Arquivo .gitmodules encontrado. Removendo para evitar erro de checkout."
            rm .gitmodules
          fi

      - name: Checkout repository (sem submodules)
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1

      # ======================================================
      # 2. Construir imagem Locust customizada
      # ======================================================
      - name: Construir imagem Locust customizada
        run: |
          echo 'FROM locustio/locust:latest' > Dockerfile.locust-custom
          echo 'RUN pip install bs4 requests' >> Dockerfile.locust-custom
          docker build -t meu-locust:latest -f Dockerfile.locust-custom .

      # ======================================================
      # 3. Testes Locust
      # ======================================================
      - name: Teste de Carga Simples (Locust via Docker)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/locust-teastore:/app \
            -w /app \
            meu-locust:latest \
            -f locustfile.py \
            --host http://teastore-webui:8080 \
            --users 5 \
            --spawn-rate 5 \
            --headless \
            --run-time 30s

      - name: Teste de Carga Complexo (Locust via Docker)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/locust-teastore:/app \
            -w /app \
            meu-locust:latest \
            -f cenarios-complexos-locust.py \
            --host http://teastore-webui:8080 \
            --users 10 \
            --spawn-rate 5 \
            --headless \
            --run-time 1m

      # ======================================================
      # 4. Gerar Dashboard Consolidado (HTML + PDF)
      # ======================================================
      - name: Gerar Dashboard Consolidado
        run: |
          mkdir -p reports
          echo "ðŸ“Š Gerando dashboard consolidado..."
          python3 generate_dashboard.py \
            --k6 k6-reports/complex.json \
            --jmeter jmeter-reports/complex.jtl \
            --locust locust-reports/locust_stats.csv \
            --out reports/dashboard.html \
            --pdf reports/dashboard.pdf

      # ======================================================
      # 5. Upload dos RelatÃ³rios
      # ======================================================
      - name: Upload dos RelatÃ³rios
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-desempenho-v14
          path: |
            k6-reports/
            jmeter-reports/
            locust-reports/
            reports/
