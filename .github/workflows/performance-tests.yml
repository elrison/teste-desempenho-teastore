name: 🧪 Testes de Desempenho TeaStore

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # ===================================================
  # 1️⃣ TESTES JMETER
  # ===================================================
  jmeter-simples:
    name: ☕ JMeter - Teste Simples
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout código
        uses: actions/checkout@v4
        with:
          submodules: false  # evita erro de submódulo TeaStore

      - name: 🐋 Build imagem Docker JMeter
        run: docker build -t jmeter-teastore ./jmeter-teastore

      - name: ▶️ Executar teste JMeter simples
        run: |
          docker run --rm -v ${{ github.workspace }}/jmeter-teastore:/opt/jmeter \
            jmeter-teastore \
            -n -t /opt/jmeter/teste-carga-simples.jmx \
            -l /opt/jmeter/results-simples.jtl \
            -e -o /opt/jmeter/report-simples

      - name: 📤 Upload resultado JMeter simples
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-simples-report
          path: jmeter-teastore/report-simples

  jmeter-complexo:
    name: ☕ JMeter - Teste Complexo
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout código
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: 🐋 Build imagem Docker JMeter
        run: docker build -t jmeter-teastore ./jmeter-teastore

      - name: ▶️ Executar teste JMeter complexo
        run: |
          docker run --rm -v ${{ github.workspace }}/jmeter-teastore:/opt/jmeter \
            jmeter-teastore \
            -n -t /opt/jmeter/cenarios-complexos.jmx \
            -l /opt/jmeter/results-complexos.jtl \
            -e -o /opt/jmeter/report-complexos

      - name: 📤 Upload resultado JMeter complexo
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-complexo-report
          path: jmeter-teastore/report-complexos

  # ===================================================
  # 2️⃣ TESTES K6
  # ===================================================
  k6-simples:
    name: ⚡ K6 - Teste Simples
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout código
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: ▶️ Executar teste K6 simples
        uses: grafana/k6-action@v0.3.1
        with:
          filename: k6-teastore/teste-carga-simples.js

  k6-complexo:
    name: ⚡ K6 - Teste Complexo
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout código
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: ▶️ Executar teste K6 complexo
        uses: grafana/k6-action@v0.3.1
        with:
          filename: k6-teastore/cenarios-complexos.js

  # ===================================================
  # 3️⃣ TESTES LOCUST
  # ===================================================
  locust-simples:
    name: 🐍 Locust - Teste Simples
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout código
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: 🐍 Instalar dependências
        run: |
          pip install locust beautifulsoup4 requests

      - name: ▶️ Executar Locust simples
        run: |
          locust -f locust-teastore/locustfile.py --headless -u 5 -r 2 -t 30s --html locust-teastore/relatorio_simples.html --host http://localhost:8080

      - name: 📤 Upload relatório Locust simples
        uses: actions/upload-artifact@v4
        with:
          name: locust-simples-report
          path: locust-teastore/relatorio_simples.html

  locust-complexo:
    name: 🐍 Locust - Teste Complexo
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout código
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: 🐍 Instalar dependências
        run: |
          pip install locust beautifulsoup4 requests

      - name: ▶️ Executar Locust complexo
        run: |
          locust -f locust-teastore/cenarios-complexos-locust.py --headless -u 5 -r 2 -t 30s --html locust-teastore/relatorio_teastore.html --host http://localhost:8080

      - name: 📤 Upload relatório Locust complexo
        uses: actions/upload-artifact@v4
        with:
          name: locust-complexo-report
          path: locust-teastore/relatorio_teastore.html
