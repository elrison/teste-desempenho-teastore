name: Performance Tests - TeaStore

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  performance-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      teastore-db:
        image: mysql:5.7
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
          MYSQL_DATABASE: "teastore"
        ports:
          - 3306:3306

      teastore-registry:
        image: descartesresearch/teastore-registry:latest
        env:
          DB_HOST: teastore-db
          DB_PORT: 3306

      teastore-persistence:
        image: descartesresearch/teastore-persistence:latest
        env:
          REGISTRY_HOST: teastore-registry
          MYSQL_HOST: teastore-db
          MYSQL_PORT: 3306
          MYSQL_DB: teastore
          MYSQL_USER: root
          MYSQL_PASS: ""

      teastore-recommender:
        image: descartesresearch/teastore-recommender:latest
        env:
          REGISTRY_HOST: teastore-registry

      teastore-auth:
        image: descartesresearch/teastore-auth:latest
        env:
          REGISTRY_HOST: teastore-registry

      teastore-image:
        image: descartesresearch/teastore-image:latest
        env:
          REGISTRY_HOST: teastore-registry

      teastore-webui:
        image: descartesresearch/teastore-webui:latest
        env:
          REGISTRY_HOST: teastore-registry
        ports:
          - 18081:8080

    steps:
      - name: Checkout do reposit칩rio
        uses: actions/checkout@v4

      - name: Esperar DB ficar online
        run: |
          for i in {1..30}; do
            nc -z teastore-db 3306 && echo "DB online" && exit 0
            sleep 2
          done
          echo "Timeout esperando o DB"
          exit 1

      - name: Esperar WebUI ficar online
        run: |
          for i in {1..30}; do
            nc -z teastore-webui 8080 && echo "WebUI online" && exit 0
            sleep 2
          done
          echo "Timeout esperando WebUI"
          exit 1

      - name: Instalar Java e JMeter
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jdk
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xvzf apache-jmeter-5.6.2.tgz
          export PATH=$PATH:apache-jmeter-5.6.2/bin

      - name: Rodar JMeter - Carga simples
        run: |
          apache-jmeter-5.6.2/bin/jmeter -n \
            -t jmeter-teastore/teste-carga-simples.jmx \
            -l jmeter-teastore/results-simples.jtl

      - name: Gerar relat칩rio HTML (simples)
        run: |
          mkdir jmeter-teastore/report-simples
          apache-jmeter-5.6.2/bin/jmeter -g jmeter-teastore/results-simples.jtl \
            -o jmeter-teastore/report-simples

      - name: Rodar JMeter - Cen치rios complexos
        run: |
          apache-jmeter-5.6.2/bin/jmeter -n \
            -t jmeter-teastore/cenarios-complexos.jmx \
            -l jmeter-teastore/results-complexos.jtl

      - name: Gerar relat칩rio HTML (complexo)
        run: |
          mkdir jmeter-teastore/report-complexos
          apache-jmeter-5.6.2/bin/jmeter -g jmeter-teastore/results-complexos.jtl \
            -o jmeter-teastore/report-complexos

      - name: Instalar k6
        run: |
          sudo apt-get install -y debian-keyring debian-archive-keyring
          curl -s https://dl.k6.io/key.gpg | sudo apt-key add -
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Rodar k6 - Simples
        run: |
          k6 run k6-teastore/teste-carga-simples.js

      - name: Rodar k6 - Complexos
        run: |
          k6 run k6-teastore/cenarios-complexos.js

      - name: Instalar Locust
        run: |
          pip install locust==2.16.1

      - name: Rodar Locust - Headless (Simples)
        run: |
          locust -f locust-teastore/locustfile.py \
            --headless -u 20 -r 5 -t 30s \
            --host http://teastore-webui:8080

      - name: Rodar Locust - Headless (Complexo)
        run: |
          locust -f locust-teastore/cenarios-complexos-locust.py \
            --headless -u 20 -r 5 -t 30s \
            --host http://teastore-webui:8080

      - name: Publicar artefatos
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            jmeter-teastore/report-simples
            jmeter-teastore/report-complexos
            jmeter-teastore/results-simples.jtl
            jmeter-teastore/results-complexos.jtl 
            k6-teastore/teste-carga-simples-*.json
            k6-teastore/cenarios-complexos-*.json
            locust-teastore/locustfile-stats.csv
            locust-teastore/cenarios-complexos-locust-stats.csv
  