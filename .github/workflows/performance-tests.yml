name: Teste de Desempenho - TeaStore v13

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  performance:
    runs-on: ubuntu-latest

    steps:
      # ======================================================
      # 1. Checkout do reposit√≥rio
      # ======================================================
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      # ======================================================
      # 2. Diagn√≥stico de estrutura
      # ======================================================
      - name: Verificar estrutura de diret√≥rios
        run: |
          echo "üìÇ Estrutura de diret√≥rios atual:"
          ls -R

      # ======================================================
      # 3. Instalar depend√™ncias (K6, JMeter, Locust, Python)
      # ======================================================
      - name: Instalar depend√™ncias
        run: |
          sudo apt update -y
          sudo apt install -y default-jdk python3 python3-pip unzip
          pip install matplotlib pandas reportlab
          
          # Instalar k6
          wget https://dl.k6.io/releases/latest/k6-v0.49.0-linux-amd64.tar.gz
          tar -xvzf k6-v0.49.0-linux-amd64.tar.gz
          sudo mv k6-v0.49.0-linux-amd64/k6 /usr/local/bin/

          # Instalar JMeter
          wget https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-5.6.3.zip
          unzip -q apache-jmeter-5.6.3.zip
          sudo mv apache-jmeter-5.6.3 /opt/jmeter

          # Instalar Locust
          pip install locust

      # ======================================================
      # 4. Executar Teste Simples (K6)
      # ======================================================
      - name: Executar teste simples (K6)
        run: |
          mkdir -p k6-reports
          SCRIPT="./k6-teastore/teste-carga-simples.js"

          if [ ! -f "$SCRIPT" ]; then
            echo "‚ùå Arquivo n√£o encontrado em $SCRIPT"
            echo "Listando diret√≥rios:"
            ls -R
            exit 1
          fi

          echo "‚úÖ Executando $SCRIPT ..."
          k6 run "$SCRIPT" --summary-export=k6-reports/simple.json

      # ======================================================
      # 5. Executar Teste Complexo (K6)
      # ======================================================
      - name: Executar teste complexo (K6)
        run: |
          mkdir -p k6-reports
          SCRIPT="./k6-teastore/teste-carga-complexo.js"

          if [ ! -f "$SCRIPT" ]; then
            echo "‚ùå Arquivo n√£o encontrado em $SCRIPT"
            echo "Listando diret√≥rios:"
            ls -R
            exit 1
          fi

          echo "‚úÖ Executando $SCRIPT ..."
          k6 run "$SCRIPT" --summary-export=k6-reports/complex.json

      # ======================================================
      # 6. Executar JMeter (simples e complexo)
      # ======================================================
      - name: Executar testes JMeter
        run: |
          mkdir -p jmeter-reports

          SIMPLE="./jmeter-teastore/teste-simples.jmx"
          COMPLEX="./jmeter-teastore/teste-complexo.jmx"

          echo "üß™ Executando JMeter Simples..."
          /opt/jmeter/bin/jmeter -n -t "$SIMPLE" -l jmeter-reports/simple.jtl

          echo "üß™ Executando JMeter Complexo..."
          /opt/jmeter/bin/jmeter -n -t "$COMPLEX" -l jmeter-reports/complex.jtl -e -o jmeter-reports/dashboard

      # ======================================================
      # 7. Executar Locust
      # ======================================================
      - name: Executar testes Locust
        run: |
          mkdir -p locust-reports
          FILE="./locust-teastore/locustfile.py"

          echo "‚úÖ Executando Locust com $FILE ..."
          locust -f "$FILE" --headless -u 10 -r 2 -t 30s --csv=locust-reports/locust

      # ======================================================
      # 8. Gerar Dashboard Consolidado
      # ======================================================
      - name: Gerar dashboard consolidado
        run: |
          mkdir -p reports
          python3 generate_dashboard.py \
            --k6 k6-reports/complex.json \
            --jmeter jmeter-reports/complex.jtl \
            --locust locust-reports/locust_stats.csv \
            --out reports/dashboard.html \
            --pdf reports/dashboard.pdf

      # ======================================================
      # 9. Upload dos relat√≥rios
      # ======================================================
      - name: Upload dos relat√≥rios
        uses: actions/upload-artifact@v4
        with:
          name: resultados-desempenho
          path: |
            k6-reports/
            jmeter-reports/
            locust-reports/
            reports/
