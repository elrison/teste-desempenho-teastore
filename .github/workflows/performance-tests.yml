name: Performance Tests

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  performance-tests:
    runs-on: ubuntu-latest

    env:
      JMETER_TEST_SIMPLE: jmeter-teastore/teste-simples.jmx
      JMETER_TEST_COMPLEX: jmeter-teastore/teste-complexo.jmx
      DOCKER_COMPOSE_FILE: docker-compose.yml

    steps:
    # ---------------------------------
    # CHECKOUT
    # ---------------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # ---------------------------------
    # PYTHON + DEPENDÊNCIAS
    # ---------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Instalar dependências Python
      run: |
        pip install requests beautifulsoup4 Jinja2 fpdf pandas lxml watchdog

    # ---------------------------------
    # SUBIR INFRA (DOCKER)
    # ---------------------------------
    - name: Subir ambiente com Docker Compose
      run: |
        docker compose -f $DOCKER_COMPOSE_FILE up -d
        echo "Aguardando serviços subirem..."
        sleep 20

    # ---------------------------------
    # CONFIGURA JMeter
    # ---------------------------------
    - name: Instalar Apache JMeter 5.6
      run: |
        wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
        tar -xzf apache-jmeter-5.6.2.tgz
        mv apache-jmeter-5.6.2 jmeter

    # ---------------------------------
    # RODAR TESTES JMETER (SIMPLES)
    # ---------------------------------
    - name: Rodar testes JMeter (Simples)
      run: |
        mkdir -p jmeter-output/simple
        jmeter/bin/jmeter \
          -n \
          -t $JMETER_TEST_SIMPLE \
          -l jmeter-output/simple/results.jtl \
          -e -o jmeter-output/simple/report

    # ---------------------------------
    # RODAR TESTES JMETER (COMPLEXOS)
    # ---------------------------------
    - name: Rodar testes JMeter (Complexos)
      run: |
        mkdir -p jmeter-output/complex
        jmeter/bin/jmeter \
          -n \
          -t $JMETER_TEST_COMPLEX \
          -l jmeter-output/complex/results.jtl \
          -e -o jmeter-output/complex/report

    # ---------------------------------
    # RODAR TESTES K6 (SIMPLES + COMPLEXO)
    # ---------------------------------
    - name: Instalar K6
      run: |
        sudo apt-get update
        sudo apt-get install -y gnupg software-properties-common
        sudo gpg -k
        sudo apt-get install -y k6

    - name: Rodar testes K6
      run: |
        mkdir -p k6-output
        k6 run k6-teastore/teste-carga-simples.js --summary-export=k6-output/k6-simple.json
        k6 run k6-teastore/cenarios-complexos.js --summary-export=k6-output/k6-complex.json

    # ---------------------------------
    # RODAR TESTES LOCUST
    # ---------------------------------
    - name: Rodar Locust testes
      run: |
        mkdir -p locust-output
        locust -f locust-teastore/locustfile.py \
          --headless \
          -u 20 \
          -r 5 \
          --run-time 1m \
          --html locust-output/complex.html

    # ---------------------------------
    # DEBUG – VERIFICAR ARQUIVOS
    # ---------------------------------
    - name: DEBUG – Listar arquivos
      run: |
        echo "==== K6 ===="
        find k6-output -type f
        echo "==== JMeter ===="
        find jmeter-output -type f
        echo "==== Locust ===="
        find locust-output -type f

    # ---------------------------------
    # GERAR DASHBOARD FINAL
    # ---------------------------------
    - name: Gerar relatório final (Dashboard + PDF)
      run: |
        python3 generate_dashboard.py \
          --k6-simple k6-output/k6-simple.json \
          --k6-complex k6-output/k6-complex.json \
          --jmeter-simple jmeter-output/simple/results.jtl \
          --jmeter-complex jmeter-output/complex/results.jtl \
          --locust locust-output/complex.html \
          --out dashboard.html \
          --pdf report.pdf

    # ---------------------------------
    # PUBLICAR ARTEFATOS
    # ---------------------------------
    - name: Upload artefatos
      uses: actions/upload-artifact@v4
      with:
        name: performance-reports
        path: |
          dashboard.html
          report.pdf
          jmeter-output/
          k6-output/
          locust-output/

    # ---------------------------------
    # FINALIZAR AMBIENTE
    # ---------------------------------
    - name: Derrubar Docker Compose
      if: always()
      run: docker compose -f $DOCKER_COMPOSE_FILE down
