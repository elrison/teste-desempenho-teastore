name: Performance Tests - TeaStore

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:

  setup-teastore:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Start TeaStore Stack
        run: |
          docker-compose up -d
          echo "⏳ Aguardando serviços..."
          sleep 40

      - name: Show Running Containers
        run: docker ps -a


  jmeter-tests:
    runs-on: ubuntu-latest
    needs: setup-teastore

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Java & JMeter
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jre-headless
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xzf apache-jmeter-5.6.2.tgz

      - name: Run Simple Load Test (JMeter)
        run: |
          ./apache-jmeter-5.6.2/bin/jmeter \
            -n -t jmeter-teastore/teste-carga-simples.jmx \
            -Jhostname=teastore-webui \
            -Jport=8080 \
            -l jmeter-teastore/results-simples.jtl \
            -e -o jmeter-teastore/report-simples

      - name: Run Complex Load Test (JMeter)
        run: |
          ./apache-jmeter-5.6.2/bin/jmeter \
            -n -t jmeter-teastore/teste-carga-complexa.jmx \
            -Jhostname=teastore-webui \
            -Jport=8080 \
            -l jmeter-teastore/results-complexa.jtl \
            -e -o jmeter-teastore/report-complexa

      - name: Upload JMeter Reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-reports
          path: |
            jmeter-teastore/report-simples
            jmeter-teastore/report-complexa


  k6-tests:
    runs-on: ubuntu-latest
    needs: setup-teastore

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install K6
        run: |
          sudo apt update
          sudo apt install -y gpg
          sudo gpg -k
          curl -s https://repo.k6.io/key.gpg | sudo apt-key add -
          echo "deb https://repo.k6.io/apt stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt update
          sudo apt install -y k6

      - name: Run K6 Smoke Test
        run: |
          k6 run k6/smoke.js --address teastore-webui:8080

      - name: Run K6 Load Test
        run: |
          k6 run k6/load.js --address teastore-webui:8080


  locust-tests:
    runs-on: ubuntu-latest
    needs: setup-teastore

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Locust
        run: pip install locust requests

      - name: Run Locust Load Test
        run: |
          locust -f locust/locustfile.py \
            --host http://teastore-webui:8080 \
            --users 50 \
            --spawn-rate 5 \
            --run-time 1m \
            --headless \
            --print-stats \
            --only-summary
